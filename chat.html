<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hela Code â€” AI Coding Assistant</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary: #8B5FBF;
            --primary-light: #9D76C1;
            --primary-dark: #6D3F9F;
            --text: #FFFFFF;
            --text-light: #B0B0B0;
            --background: #121212;
            --card-bg: #1E1E1E;
            --card-hover: #252525;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            --transition: all 0.3s ease;
            --success: #4CAF50;
            --warning: #ff9800;
            --error: #f44336;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background);
            color: var(--text);
            line-height: 1.6;
            overflow-x: hidden;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        /* Header - DeepSeek Style */
        header {
            padding: 15px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            background: var(--background);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 700;
            font-size: 1.5rem;
            color: var(--primary);
        }
        
        .logo-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }
        
        .user-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .credit-bar {
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--card-bg);
            padding: 8px 16px;
            border-radius: 20px;
            box-shadow: var(--shadow);
            font-weight: 500;
        }
        
        .credit-bar.low {
            animation: pulse 2s infinite;
        }
        
        .nav-buttons {
            display: flex;
            gap: 10px;
        }
        
        .nav-btn {
            background: var(--card-bg);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 8px 12px;
            color: var(--text);
            cursor: pointer;
            transition: var(--transition);
            font-size: 0.9rem;
        }
        
        .nav-btn:hover {
            background: var(--primary);
            transform: translateY(-2px);
        }
        
        @keyframes pulse {
            0% { box-shadow: var(--shadow); }
            50% { box-shadow: 0 0 0 3px rgba(139, 95, 191, 0.4); }
            100% { box-shadow: var(--shadow); }
        }
        
        /* Main Layout - DeepSeek Style */
        .main-layout {
            display: flex;
            gap: 20px;
            min-height: calc(100vh - 120px);
        }
        
        .sidebar {
            width: 300px;
            background: var(--card-bg);
            border-radius: 16px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            margin-top: 20px;
        }
        
        .chat-area {
            flex: 1;
            background: var(--card-bg);
            border-radius: 16px;
            display: flex;
            flex-direction: column;
            margin-top: 20px;
        }
        
        /* Chat Messages - DeepSeek Style */
        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .message {
            display: flex;
            gap: 12px;
            max-width: 100%;
            padding: 15px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.05);
            margin-bottom: 10px;
        }
        
        .message.user {
            align-self: flex-end;
            flex-direction: row-reverse;
            background: rgba(139, 95, 191, 0.15);
        }
        
        .message.ai {
            align-self: flex-start;
            background: rgba(255, 255, 255, 0.05);
        }
        
        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            flex-shrink: 0;
        }
        
        .message-bubble {
            padding: 12px 16px;
            border-radius: 18px;
            line-height: 1.4;
            flex: 1;
        }
        
        .message.user .message-bubble {
            background: var(--primary);
            color: white;
        }
        
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-light);
        }
        
        .typing-dots {
            display: flex;
            gap: 4px;
        }
        
        .typing-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--text-light);
            animation: typing 1.4s infinite;
        }
        
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-5px); }
        }
        
        /* Chat Input - DeepSeek Style */
        .chat-input-container {
            padding: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .chat-input-wrapper {
            display: flex;
            gap: 10px;
            align-items: flex-end;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            padding: 10px;
        }
        
        .chat-input {
            flex: 1;
            background: transparent;
            border: none;
            padding: 12px 16px;
            color: var(--text);
            font-family: inherit;
            font-size: 1rem;
            resize: none;
            max-height: 120px;
            min-height: 44px;
        }
        
        .chat-input:focus {
            outline: none;
        }
        
        .send-btn {
            background: var(--primary);
            border: none;
            border-radius: 12px;
            padding: 12px 20px;
            color: white;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .send-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }
        
        /* Welcome Screen - DeepSeek Style */
        .welcome-screen {
            text-align: center;
            padding: 60px 40px;
        }
        
        .welcome-title {
            font-size: 2.5rem;
            color: var(--primary);
            margin-bottom: 20px;
        }
        
        .welcome-subtitle {
            color: var(--text-light);
            margin-bottom: 40px;
            font-size: 1.2rem;
        }
        
        /* Example Prompts - Reduced to 3 */
        .example-prompts {
            max-width: 800px;
            margin: 0 auto;
        }
        
        .example-category {
            margin-bottom: 30px;
        }
        
        .category-title {
            color: var(--primary);
            font-size: 1.1rem;
            margin-bottom: 12px;
            font-weight: 600;
        }
        
        .prompts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 10px;
        }
        
        .example-prompt-btn {
            background: rgba(139, 95, 191, 0.1);
            border: 1px solid rgba(139, 95, 191, 0.3);
            border-radius: 8px;
            padding: 12px 16px;
            color: var(--text);
            text-align: left;
            cursor: pointer;
            transition: var(--transition);
            font-size: 0.9rem;
            line-height: 1.4;
        }
        
        .example-prompt-btn:hover {
            background: rgba(139, 95, 191, 0.2);
            border-color: var(--primary);
            transform: translateX(5px);
        }
        
        /* Chat History */
        .chat-history {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 20px;
        }
        
        .chat-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: var(--transition);
            margin-bottom: 5px;
        }
        
        .chat-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        
        .chat-item.active {
            background: rgba(139, 95, 191, 0.2);
            border-left: 3px solid var(--primary);
        }
        
        .chat-item-icon {
            font-size: 1.2rem;
        }
        
        .chat-item-title {
            flex: 1;
            font-size: 0.9rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .delete-chat {
            background: none;
            border: none;
            color: var(--text-light);
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            opacity: 0;
            transition: var(--transition);
        }
        
        .chat-item:hover .delete-chat {
            opacity: 1;
        }
        
        .delete-chat:hover {
            color: var(--error);
            background: rgba(244, 67, 54, 0.1);
        }
        
        /* File Upload */
        .file-preview {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }
        
        .file-preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .file-name {
            font-weight: 600;
            color: var(--primary);
        }
        
        .remove-file {
            background: none;
            border: none;
            color: var(--text-light);
            cursor: pointer;
            font-size: 1.2rem;
            padding: 0 5px;
        }
        
        .remove-file:hover {
            color: var(--error);
        }
        
        .file-content {
            font-family: monospace;
            font-size: 0.8rem;
            color: var(--text-light);
            max-height: 200px;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 4px;
        }
        
        /* Notifications */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--card-bg);
            border: 1px solid;
            border-radius: 8px;
            padding: 12px 20px;
            z-index: 1000;
            box-shadow: var(--shadow);
            max-width: 300px;
        }
        
        .notification.success {
            border-color: var(--success);
            background: rgba(76, 175, 80, 0.1);
        }
        
        .notification.error {
            border-color: var(--error);
            background: rgba(244, 67, 54, 0.1);
        }
        
        /* Modals */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
            position: relative;
        }
        
        .modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-light);
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-close:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .modal-title {
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: var(--primary);
        }
        
        /* Challenges & Achievements */
        .challenges-grid, .achievements-grid {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
        }
        
        .challenge-card, .achievement-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
            display: flex;
            align-items: flex-start;
            gap: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .challenge-card {
            border-left: 4px solid var(--primary);
        }
        
        .achievement-card.unlocked {
            border-left: 4px solid var(--success);
        }
        
        .achievement-card.locked {
            border-left: 4px solid #666;
            opacity: 0.7;
        }
        
        .challenge-icon, .achievement-icon {
            font-size: 2rem;
            flex-shrink: 0;
        }
        
        .challenge-info, .achievement-info {
            flex: 1;
        }
        
        .challenge-info h4, .achievement-info h4 {
            color: var(--text);
            margin-bottom: 5px;
            font-size: 1.1rem;
        }
        
        .challenge-info p, .achievement-info p {
            color: var(--text-light);
            margin-bottom: 10px;
            font-size: 0.9rem;
        }
        
        .progress-bar {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            height: 6px;
            margin: 10px 0;
            overflow: hidden;
        }
        
        .progress-fill {
            background: var(--primary);
            height: 100%;
            border-radius: 10px;
            transition: width 0.3s ease;
        }
        
        .challenge-reward, .achievement-xp {
            color: var(--primary);
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .achievement-status {
            font-size: 0.8rem;
            font-weight: 600;
            margin-top: 5px;
        }
        
        .achievement-card.unlocked .achievement-status {
            color: var(--success);
        }
        
        .achievement-card.locked .achievement-status {
            color: #666;
        }
        
        .progress-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .stat {
            text-align: center;
            padding: 15px;
            background: rgba(139, 95, 191, 0.1);
            border-radius: 8px;
        }
        
        .stat h4 {
            color: var(--text-light);
            font-size: 0.9rem;
            margin-bottom: 5px;
        }
        
        .stat p {
            color: var(--primary);
            font-size: 1.2rem;
            font-weight: 700;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .main-layout {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                order: 2;
            }
            
            .chat-area {
                order: 1;
            }
            
            .message {
                max-width: 90%;
            }
            
            .prompts-container {
                grid-template-columns: 1fr;
            }
            
            .progress-stats {
                grid-template-columns: 1fr;
            }
            
            header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .user-section {
                justify-content: center;
            }
        }
        
        @media (max-width: 480px) {
            .container {
                padding: 0 15px;
            }
            
            .welcome-screen {
                padding: 40px 20px;
            }
            
            .welcome-title {
                font-size: 2rem;
            }
            
            .modal-content {
                padding: 20px;
            }
        }
        
        /* User Profile */
        .user-profile {
            display: flex;
            align-items: center;
            gap: 12px;
            background: var(--card-bg);
            padding: 8px 16px;
            border-radius: 20px;
            margin-right: 15px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.1rem;
        }

        .user-info {
            display: flex;
            flex-direction: column;
        }

        .user-name {
            font-weight: 600;
            font-size: 0.9rem;
        }

        .user-level {
            font-size: 0.8rem;
            color: var(--text-light);
        }

        /* Code Syntax Highlighting - DeepSeek Style */
        code {
            background: rgba(0, 0, 0, 0.3);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            color: #f8f8f2;
        }

        pre {
            background: #1e1e1e;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 16px;
            overflow-x: auto;
            margin: 12px 0;
            position: relative;
        }

        pre code {
            background: none;
            padding: 0;
            border-radius: 0;
            color: #f8f8f2;
        }

        .code-block {
            position: relative;
            margin: 15px 0;
        }

        .code-header {
            background: #2d2d2d;
            padding: 8px 12px;
            border-radius: 8px 8px 0 0;
            border: 1px solid #333;
            border-bottom: none;
            font-size: 0.8rem;
            color: #ccc;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .copy-code-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            padding: 4px 8px;
            color: var(--text);
            cursor: pointer;
            font-size: 0.7rem;
            transition: var(--transition);
        }

        .copy-code-btn:hover {
            background: var(--primary);
        }
        
        .download-code-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            padding: 4px 8px;
            color: var(--text);
            cursor: pointer;
            font-size: 0.7rem;
            transition: var(--transition);
            margin-left: 8px;
        }

        .download-code-btn:hover {
            background: var(--success);
        }
        
        /* Language-specific colors */
        .language-javascript { color: #f1fa8c; }
        .language-python { color: #8be9fd; }
        .language-html { color: #ff79c6; }
        .language-css { color: #50fa7b; }
        .language-json { color: #bd93f9; }
        .language-java { color: #ffb86c; }
        .language-php { color: #8be9fd; }
        .language-sql { color: #50fa7b; }
        .language-bash { color: #ff79c6; }
        .language-text { color: #f8f8f2; }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="container">
        <div class="logo">
            <div class="logo-icon">
                <i class="fas fa-code"></i>
            </div>
            <span>Hela Code</span>
        </div>
        <div class="user-section">
            <div class="user-profile">
                <div class="user-avatar" id="userAvatar">
                    <i class="fas fa-user"></i>
                </div>
                <div class="user-info">
                    <div class="user-name" id="userName">Guest</div>
                    <div class="user-level">Level <span id="userLevel">1</span></div>
                </div>
            </div>
            <div class="credit-bar" id="creditBar">
                <i class="fas fa-gem"></i>
                <span>Credits: <span id="creditsDisplay">05</span></span>
            </div>
            <div class="nav-buttons">
                <button class="nav-btn" id="challengesBtn" title="Challenges">
                    <i class="fas fa-tasks"></i>
                </button>
                <button class="nav-btn" id="achievementsBtn" title="Achievements">
                    <i class="fas fa-trophy"></i>
                </button>
                <button class="nav-btn" id="logoutBtn" title="Logout">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="container">
        <div class="main-layout">
            <!-- Sidebar -->
            <div class="sidebar">
                <button class="nav-btn" id="newChatBtn" style="margin-bottom: 20px;">
                    <i class="fas fa-plus"></i> New Chat
                </button>
                <div class="chat-history" id="chatHistory">
                    <div class="no-chats">No conversations yet</div>
                </div>
            </div>

            <!-- Chat Area -->
            <div class="chat-area">
                <!-- Welcome Screen -->
                <div class="welcome-screen" id="welcomeScreen">
                    <h1 class="welcome-title">Welcome to Hela Code</h1>
                    <p class="welcome-subtitle">Sri Lanka's #1 AI Coding Assistant</p>
                    <div class="example-prompts" id="examplePrompts">
                        <!-- Example prompts will be loaded here -->
                    </div>
                </div>

                <!-- Chat Messages -->
                <div class="chat-messages" id="chatMessages">
                    <!-- Messages will be loaded here -->
                </div>

                <!-- Chat Input -->
                <div class="chat-input-container">
                    <div class="chat-input-wrapper">
                        <textarea 
                            class="chat-input" 
                            id="chatInput" 
                            placeholder="Ask me anything about coding..."
                            rows="1"
                        ></textarea>
                        <button class="send-btn" id="sendBtn">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAkZ1COLT59ukLGzpv5lW3UZ8vQ9tEN1gw",
            authDomain: "hela-code.firebaseapp.com",
            projectId: "hela-code",
            storageBucket: "hela-code.appspot.com",
            messagingSenderId: "813299203715",
            appId: "1:813299203715:web:910e7227cdd4a09ad1a5b6"
        };

        // Initialize Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }

        const auth = firebase.auth();
        const db = firebase.firestore();

        // ==================== GLOBAL STATE ====================
        let state = {
            currentChatId: null,
            chats: [],
            currentUser: null,
            uploadedFiles: [],
            isInitialized: false,
            userProgress: {
                achievements: [],
                challenges: [],
                credits: 05,
                level: 1,
                xp: 0,
                lastActive: null,
                stats: {
                    messagesSent: 0,
                    codeQuestions: 0,
                    filesUploaded: 0,
                    chatsCreated: 0,
                    consecutiveDays: 0
                }
            }
        };

        // ==================== SYSTEM PROMPT & AI CONFIG ====================
        const SYSTEM_PROMPT = `You are Hela Code, Sri Lanka's premier AI coding assistant. Your role is to help developers of all skill levels with coding, debugging, learning, and problem-solving.

IMPORTANT FORMATTING INSTRUCTIONS:
1. ALWAYS use proper code blocks with language specification
2. Format code like this: \`\`\`language
   your code here
   \`\`\`
3. Supported languages: javascript, python, html, css, java, php, sql, json, bash
4. Provide COMPLETE, RUNNABLE code examples
5. Include explanations with code.

CORE PRINCIPLES:
1. Be helpful, accurate, and efficient in your responses
2. Explain concepts clearly with appropriate technical depth
3. Provide practical, working code examples
4. Encourage learning and best practices
5. Be patient and supportive with beginners

SPECIALIZATIONS:
- Web Development (HTML, CSS, JavaScript, React, Node.js)
- Mobile Development (React Native, Flutter)
- Backend Development (Python, Java, PHP, Databases)
- DevOps & Cloud (AWS, Docker, CI/CD)
- Data Science & Machine Learning
- Software Architecture & Design Patterns
- Code Review & Optimization
- Debugging & Problem Solving

RESPONSE GUIDELINES:
- Structure complex answers with clear sections
- Use code blocks with proper syntax highlighting
- Explain the "why" behind solutions, not just the "how"
- Suggest alternative approaches when relevant
- Point out potential pitfalls and best practices
- Keep responses concise but comprehensive
- Admit when you don't know something rather than guessing

TONE & STYLE:
- Professional yet approachable
- Encouraging and supportive
- Culturally aware of Sri Lankan developer community
- Use Sinhala/Tamil greetings when appropriate
- Balance technical accuracy with accessibility

SECURITY & ETHICS:
- Never provide harmful code or security vulnerabilities
- Respect intellectual property and licensing
- Promote secure coding practices
- Avoid biased or discriminatory content

Remember: You're here to empower Sri Lankan developers and contribute to the growth of the local tech ecosystem.`;

        const API_CONFIG = {
            URL: 'https://endpoint.apilageai.lk/api/chat',
            KEY: 'apk_QngciclzfHi2yAfP3WvZgx68VbbONQTP',
            MODEL: 'APILAGEAI-FREE'
        };

        // ==================== ACHIEVEMENTS & CHALLENGES SYSTEM ====================
        const ACHIEVEMENTS = {
            FIRST_CHAT: {
                id: 'first_chat',
                name: 'First Conversation',
                description: 'Send your first message to Hela Code',
                icon: 'ðŸ’¬',
                xp: 50,
                check: (stats) => stats.messagesSent >= 1
            },
            CODE_WIZARD: {
                id: 'code_wizard',
                name: 'Code Wizard',
                description: 'Ask 10 coding questions',
                icon: 'ðŸ§™',
                xp: 100,
                check: (stats) => stats.codeQuestions >= 10
            },
            BUG_HUNTER: {
                id: 'bug_hunter',
                name: 'Bug Hunter',
                description: 'Debug 5 different issues',
                icon: 'ðŸ›',
                xp: 150,
                check: (stats) => stats.messagesSent >= 20 // Simplified for demo
            },
            FILE_EXPERT: {
                id: 'file_expert',
                name: 'File Expert',
                description: 'Upload and analyze 3 different files',
                icon: 'ðŸ“',
                xp: 75,
                check: (stats) => stats.filesUploaded >= 3
            },
            CHAT_MASTER: {
                id: 'chat_master',
                name: 'Chat Master',
                description: 'Create 5 different chat sessions',
                icon: 'ðŸ’Ž',
                xp: 200,
                check: (stats) => stats.chatsCreated >= 5
            },
            CONSISTENT_LEARNER: {
                id: 'consistent_learner',
                name: 'Consistent Learner',
                description: 'Use Hela Code for 3 consecutive days',
                icon: 'ðŸ“š',
                xp: 100,
                check: (stats) => stats.consecutiveDays >= 3
            }
        };

        const CHALLENGES = {
            WEEKLY_LEARNER: {
                id: 'weekly_learner',
                name: 'Weekly Learner',
                description: 'Use Hela Code for 3 consecutive days',
                icon: 'ðŸ“š',
                reward: 50,
                duration: 3,
                check: (stats) => stats.consecutiveDays
            },
            CODE_EXPLORER: {
                id: 'code_explorer',
                name: 'Code Explorer',
                description: 'Ask questions about 3 different programming languages',
                icon: 'ðŸŒ',
                reward: 75,
                duration: 3,
                check: (stats) => stats.codeQuestions
            },
            PROJECT_BUILDER: {
                id: 'project_builder',
                name: 'Project Builder',
                description: 'Complete a small project with Hela Code\'s help',
                icon: 'ðŸ—ï¸',
                reward: 100,
                duration: 1,
                check: (stats) => stats.messagesSent >= 15
            }
        };

        // ==================== DOM ELEMENTS ====================
        let elements = {};

        // ==================== UTILITY FUNCTIONS ====================
        function showNotification(message, type = 'success') {
            try {
                // Remove existing notifications
                document.querySelectorAll('.notification').forEach(notif => notif.remove());
                
                const notif = document.createElement('div');
                notif.className = `notification ${type}`;
                notif.textContent = message;
                document.body.appendChild(notif);
                
                setTimeout(() => {
                    if (notif.parentNode) {
                        notif.parentNode.removeChild(notif);
                    }
                }, 3000);
            } catch (error) {
                console.error('Error showing notification:', error);
            }
        }

        function escapeHTML(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function scrollToBottom() {
            setTimeout(() => {
                try {
                    if (elements.chatMessages) {
                        elements.chatMessages.scrollTop = elements.chatMessages.scrollHeight;
                    }
                } catch (error) {
                    console.error('Error scrolling:', error);
                }
            }, 100);
        }

        function autoResizeTextarea() {
            try {
                if (elements.chatInput) {
                    elements.chatInput.style.height = 'auto';
                    elements.chatInput.style.height = Math.min(elements.chatInput.scrollHeight, 120) + 'px';
                }
            } catch (error) {
                console.error('Error resizing textarea:', error);
            }
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function generateChatId() {
            return 'chat_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // ==================== TYPING INDICATOR FUNCTIONS ====================
        function removeTypingIndicator() {
            try {
                const typing = document.getElementById('typing-indicator');
                if (typing && typing.parentNode) {
                    typing.parentNode.removeChild(typing);
                }
            } catch (error) {
                console.error('Error removing typing indicator:', error);
            }
        }

        function showTypingIndicator() {
            try {
                // Remove any existing typing indicator first
                removeTypingIndicator();
                
                const typingDiv = document.createElement('div');
                typingDiv.className = 'message ai';
                typingDiv.id = 'typing-indicator';
                
                const avatar = document.createElement('div');
                avatar.className = 'message-avatar';
                avatar.textContent = 'H';
                typingDiv.appendChild(avatar);
                
                const messageContent = document.createElement('div');
                messageContent.className = 'message-content';
                
                const messageBubble = document.createElement('div');
                messageBubble.className = 'message-bubble ai-bubble typing-indicator';
                messageBubble.innerHTML = `
                    <div class="typing-dots">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                    <span>Hela Code is thinking...</span>
                `;
                
                messageContent.appendChild(messageBubble);
                typingDiv.appendChild(messageContent);
                
                if (elements.chatMessages) {
                    elements.chatMessages.appendChild(typingDiv);
                    scrollToBottom();
                }
            } catch (error) {
                console.error('Error showing typing indicator:', error);
            }
        }

        // ==================== SHARE CHAT FUNCTIONALITY ====================
        function shareChat(chatId) {
            try {
                // Create shareable URL with hash routing
                const shareUrl = `${window.location.origin}${window.location.pathname}#${chatId}`;
                
                // Try to use Web Share API if available
                if (navigator.share) {
                    navigator.share({
                        title: 'Hela Code Chat',
                        text: 'Check out this coding conversation!',
                        url: shareUrl
                    }).then(() => {
                        showNotification('Chat shared successfully!', 'success');
                    }).catch(err => {
                        // Fallback to clipboard
                        copyToClipboardText(shareUrl);
                    });
                } else {
                    // Fallback to clipboard
                    copyToClipboardText(shareUrl);
                }
            } catch (error) {
                console.error('Error sharing chat:', error);
                showNotification('Error sharing chat', 'error');
            }
        }

        function copyToClipboardText(text) {
            navigator.clipboard.writeText(text).then(() => {
                showNotification('Chat link copied to clipboard!', 'success');
            }).catch(() => {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showNotification('Chat link copied to clipboard!', 'success');
            });
        }

        // ==================== ACHIEVEMENTS & CHALLENGES FUNCTIONS ====================
        async function checkAndUnlockAchievements() {
            try {
                if (!state.currentUser) return;

                let unlockedAny = false;
                
                for (const [achievementId, achievement] of Object.entries(ACHIEVEMENTS)) {
                    if (!state.userProgress.achievements.includes(achievementId) && 
                        achievement.check(state.userProgress.stats)) {
                        await unlockAchievement(achievementId);
                        unlockedAny = true;
                    }
                }
                
                return unlockedAny;
            } catch (error) {
                console.error('Error checking achievements:', error);
            }
        }

        async function unlockAchievement(achievementId) {
            try {
                if (!state.currentUser || state.userProgress.achievements.includes(achievementId)) {
                    return;
                }

                const achievement = ACHIEVEMENTS[achievementId];
                if (!achievement) return;

                state.userProgress.achievements.push(achievementId);
                state.userProgress.xp += achievement.xp;
                
                // Check level up
                const newLevel = Math.floor(state.userProgress.xp / 100) + 1;
                if (newLevel > state.userProgress.level) {
                    state.userProgress.level = newLevel;
                    showNotification(`ðŸŽ‰ Level Up! You're now level ${newLevel}`, 'success');
                }

                // Save to Firestore
                await saveUserProgress();

                // Show achievement notification
                showNotification(`ðŸ† ${achievement.name} - ${achievement.description} +${achievement.xp}XP`, 'success');
                
                updateProgressUI();
                
            } catch (error) {
                console.error('Error unlocking achievement:', error);
            }
        }

        async function updateChallengeProgress() {
            try {
                if (!state.currentUser) return;

                let completedAny = false;
                
                for (const [challengeId, challenge] of Object.entries(CHALLENGES)) {
                    const currentProgress = challenge.check(state.userProgress.stats);
                    const userChallenge = state.userProgress.challenges.find(c => c.id === challengeId);
                    
                    if (userChallenge) {
                        // Update existing challenge progress
                        if (currentProgress > userChallenge.progress) {
                            userChallenge.progress = currentProgress;
                            if (userChallenge.progress >= challenge.duration) {
                                await completeChallenge(challengeId);
                                completedAny = true;
                            }
                        }
                    } else if (currentProgress > 0) {
                        // Start new challenge
                        state.userProgress.challenges.push({
                            id: challengeId,
                            progress: currentProgress,
                            startedAt: new Date().toISOString()
                        });
                    }
                }

                if (state.userProgress.challenges.length > 0) {
                    await saveUserProgress();
                    updateProgressUI();
                }
                
                return completedAny;
            } catch (error) {
                console.error('Error updating challenge progress:', error);
            }
        }

        async function completeChallenge(challengeId) {
            try {
                const challenge = CHALLENGES[challengeId];
                if (!challenge) return;

                state.userProgress.credits += challenge.reward;
                state.userProgress.challenges = state.userProgress.challenges.filter(c => c.id !== challengeId);

                await saveUserProgress();

                showNotification(`ðŸŽ¯ ${challenge.name} completed! +${challenge.reward} credits`, 'success');
                updateProgressUI();
                
            } catch (error) {
                console.error('Error completing challenge:', error);
            }
        }

        async function saveUserProgress() {
            try {
                if (!state.currentUser) return;
                
                await db.collection('users').doc(state.currentUser.uid).set({
                    progress: state.userProgress
                }, { merge: true });
            } catch (error) {
                console.error('Error saving user progress:', error);
            }
        }

        function updateProgressUI() {
            try {
                if (elements.creditsDisplay) {
                    elements.creditsDisplay.textContent = state.userProgress.credits;
                }
                
                // Update credit bar styling
                if (elements.creditBar) {
                    if (state.userProgress.credits < 50) {
                        elements.creditBar.classList.add('low');
                    } else {
                        elements.creditBar.classList.remove('low');
                    }
                }
                
                // Update user level
                const userLevel = document.getElementById('userLevel');
                if (userLevel) {
                    userLevel.textContent = state.userProgress.level;
                }
                
            } catch (error) {
                console.error('Error updating progress UI:', error);
            }
        }

        // ==================== STATS TRACKING ====================
        function updateUserStats(updates) {
            try {
                Object.keys(updates).forEach(key => {
                    if (state.userProgress.stats.hasOwnProperty(key)) {
                        state.userProgress.stats[key] += updates[key];
                    }
                });
                
                // Check for achievements and challenges
                checkAndUnlockAchievements();
                updateChallengeProgress();
                
                // Save progress
                saveUserProgress();
            } catch (error) {
                console.error('Error updating user stats:', error);
            }
        }

        // ==================== DOM WAIT FUNCTIONS ====================
        function waitForElement(selector, timeout = 5000) {
            return new Promise((resolve, reject) => {
                const element = document.querySelector(selector);
                if (element) {
                    resolve(element);
                    return;
                }

                const observer = new MutationObserver(() => {
                    const element = document.querySelector(selector);
                    if (element) {
                        observer.disconnect();
                        resolve(element);
                    }
                });

                observer.observe(document.body, {
                    childList: true,
                    subtree: true
                });

                setTimeout(() => {
                    observer.disconnect();
                    reject(new Error(`Element ${selector} not found within ${timeout}ms`));
                }, timeout);
            });
        }

        async function initializeElements() {
            console.log('Initializing DOM elements...');
            
            try {
                elements = {
                    chatMessages: await waitForElement('#chatMessages'),
                    chatInput: await waitForElement('#chatInput'),
                    sendBtn: await waitForElement('#sendBtn'),
                    welcomeScreen: await waitForElement('#welcomeScreen'),
                    newChatBtn: await waitForElement('#newChatBtn'),
                    logoutBtn: await waitForElement('#logoutBtn'),
                    chatHistory: await waitForElement('#chatHistory'),
                    userAvatar: document.getElementById('userAvatar'),
                    userName: document.getElementById('userName'),
                    chatTitle: document.getElementById('chatTitle'),
                    fileBtn: document.getElementById('fileBtn'),
                    fileInput: document.getElementById('fileInput'),
                    shareChatBtn: document.getElementById('shareChatBtn'),
                    challengesBtn: document.getElementById('challengesBtn'),
                    achievementsBtn: document.getElementById('achievementsBtn'),
                    creditsDisplay: document.getElementById('creditsDisplay'),
                    examplePrompts: document.getElementById('examplePrompts'),
                    creditBar: document.getElementById('creditBar')
                };
                
                console.log('All DOM elements initialized successfully');
                return true;
            } catch (error) {
                console.error('Failed to initialize DOM elements:', error);
                return false;
            }
        }

        // ==================== EXAMPLE PROMPTS - REDUCED TO 3 ====================
        const EXAMPLE_PROMPTS = [
            {
                title: "Web Development",
                prompts: [
                    "How to create a responsive navbar with React?",
                    "Explain CSS Grid with a practical example",
                    "Build a simple CRUD app with Node.js and MongoDB"
                ]
            },
            {
                title: "Mobile Development", 
                prompts: [
                    "Create a Flutter app with bottom navigation",
                    "How to handle API calls in React Native?",
                    "Build a Sri Lankan restaurant finder app UI"
                ]
            },
            {
                title: "Backend & Databases",
                prompts: [
                    "Design a database schema for an e-commerce site",
                    "How to implement JWT authentication in Express.js?",
                    "Optimize MySQL queries for better performance"
                ]
            }
        ];

        function handleExamplePrompt(prompt) {
            try {
                if (elements.chatInput) {
                    elements.chatInput.value = prompt;
                    elements.chatInput.focus();
                    autoResizeTextarea();
                    showNotification('Prompt added to chat! Click send when ready.', 'success');
                }
            } catch (error) {
                console.error('Error handling example prompt:', error);
                showNotification('Error loading prompt', 'error');
            }
        }

        function displayExamplePrompts() {
            try {
                const examplesContainer = elements.examplePrompts;
                if (!examplesContainer) return;
                
                examplesContainer.innerHTML = '';
                
                EXAMPLE_PROMPTS.forEach(category => {
                    const categoryDiv = document.createElement('div');
                    categoryDiv.className = 'example-category';
                    
                    const categoryTitle = document.createElement('h4');
                    categoryTitle.textContent = category.title;
                    categoryTitle.className = 'category-title';
                    categoryDiv.appendChild(categoryTitle);
                    
                    const promptsContainer = document.createElement('div');
                    promptsContainer.className = 'prompts-container';
                    
                    category.prompts.forEach(prompt => {
                        const promptBtn = document.createElement('button');
                        promptBtn.className = 'example-prompt-btn';
                        promptBtn.textContent = prompt;
                        promptBtn.onclick = () => handleExamplePrompt(prompt);
                        promptsContainer.appendChild(promptBtn);
                    });
                    
                    categoryDiv.appendChild(promptsContainer);
                    examplesContainer.appendChild(categoryDiv);
                });
            } catch (error) {
                console.error('Error displaying example prompts:', error);
            }
        }

        // ==================== MODAL SYSTEMS ====================
        function showChallengesModal() {
            const modal = createModal('coding_challenges', 'Coding Challenges ðŸŽ¯');
            
            let challengesHTML = '<div class="challenges-grid">';
            
            Object.values(CHALLENGES).forEach(challenge => {
                const userChallenge = state.userProgress.challenges.find(c => c.id === challenge.id);
                const currentProgress = challenge.check(state.userProgress.stats);
                const progress = userChallenge ? (userChallenge.progress / challenge.duration) * 100 : (currentProgress / challenge.duration) * 100;
                
                challengesHTML += `
                    <div class="challenge-card">
                        <div class="challenge-icon">${challenge.icon}</div>
                        <div class="challenge-info">
                            <h4>${challenge.name}</h4>
                            <p>${challenge.description}</p>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${Math.min(progress, 100)}%"></div>
                            </div>
                            <div class="challenge-reward">Reward: ${challenge.reward} credits</div>
                            <div class="challenge-progress">${Math.min(currentProgress, challenge.duration)}/${challenge.duration} completed</div>
                        </div>
                    </div>
                `;
            });
            
            challengesHTML += '</div>';
            modal.querySelector('.modal-body').innerHTML = challengesHTML;
            
            document.body.appendChild(modal);
        }

        function showAchievementsModal() {
            const modal = createModal('achievements', 'Your Achievements ðŸ†');
            
            let achievementsHTML = '<div class="achievements-grid">';
            
            Object.values(ACHIEVEMENTS).forEach(achievement => {
                const unlocked = state.userProgress.achievements.includes(achievement.id);
                const progress = achievement.check(state.userProgress.stats);
                
                achievementsHTML += `
                    <div class="achievement-card ${unlocked ? 'unlocked' : 'locked'}">
                        <div class="achievement-icon">${achievement.icon}</div>
                        <div class="achievement-info">
                            <h4>${achievement.name}</h4>
                            <p>${achievement.description}</p>
                            <div class="achievement-xp">${achievement.xp} XP</div>
                            <div class="achievement-status">${unlocked ? 'âœ… Unlocked' : 'ðŸ”’ Locked'}</div>
                            ${!unlocked ? `<div class="achievement-progress">Progress: ${progress}</div>` : ''}
                        </div>
                    </div>
                `;
            });
            
            achievementsHTML += `
                <div class="progress-stats">
                    <div class="stat">
                        <h4>Level</h4>
                        <p>${state.userProgress.level}</p>
                    </div>
                    <div class="stat">
                        <h4>Total XP</h4>
                        <p>${state.userProgress.xp}</p>
                    </div>
                    <div class="stat">
                        <h4>Achievements</h4>
                        <p>${state.userProgress.achievements.length}/${Object.keys(ACHIEVEMENTS).length}</p>
                    </div>
                    <div class="stat">
                        <h4>Messages</h4>
                        <p>${state.userProgress.stats.messagesSent}</p>
                    </div>
                    <div class="stat">
                        <h4>Code Questions</h4>
                        <p>${state.userProgress.stats.codeQuestions}</p>
                    </div>
                    <div class="stat">
                        <h4>Consecutive Days</h4>
                        <p>${state.userProgress.stats.consecutiveDays}</p>
                    </div>
                </div>
            `;
            
            achievementsHTML += '</div>';
            modal.querySelector('.modal-body').innerHTML = achievementsHTML;
            
            document.body.appendChild(modal);
        }

        function createModal(id, title) {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content">
                    <button class="modal-close" onclick="this.closest('.modal').remove()">&times;</button>
                    <h3 class="modal-title">${title}</h3>
                    <div class="modal-body" id="${id}">
                        <!-- Content will be inserted here -->
                    </div>
                </div>
            `;
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
            
            return modal;
        }

        // ==================== FIREBASE OPERATIONS ====================
        async function saveChatToFirestore(chat) {
            try {
                await db.collection('users')
                    .doc(state.currentUser.uid)
                    .collection('chats')
                    .doc(chat.id)
                    .set({
                        title: chat.title,
                        messages: chat.messages,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                return true;
            } catch (error) {
                console.error('Firestore save error:', error);
                saveChatsToLocalStorage();
                return false;
            }
        }

        async function deleteChatFromFirestore(chatId) {
            try {
                await db.collection('users')
                    .doc(state.currentUser.uid)
                    .collection('chats')
                    .doc(chatId)
                    .delete();
                return true;
            } catch (error) {
                console.error('Firestore delete error:', error);
                return false;
            }
        }

        async function loadChatsFromFirestore() {
            try {
                const snapshot = await db.collection('users')
                    .doc(state.currentUser.uid)
                    .collection('chats')
                    .orderBy('updatedAt', 'desc')
                    .get();

                if (snapshot.empty) {
                    state.chats = [];
                    return true;
                }

                state.chats = snapshot.docs.map(doc => {
                    const data = doc.data();
                    return {
                        id: doc.id,
                        title: data.title || 'New Chat',
                        messages: data.messages || [],
                        createdAt: data.createdAt?.toDate?.()?.toISOString() || new Date().toISOString(),
                        updatedAt: data.updatedAt?.toDate?.()?.toISOString() || new Date().toISOString()
                    };
                });
                
                console.log(`Loaded ${state.chats.length} chats from Firestore`);
                return true;
            } catch (error) {
                console.error('Firestore load error:', error);
                return false;
            }
        }

        // ==================== LOCAL STORAGE ====================
        function saveChatsToLocalStorage() {
            try {
                if (!state.currentUser) return;
                localStorage.setItem(`helaChats_${state.currentUser.uid}`, JSON.stringify(state.chats));
            } catch (error) {
                console.error('Local storage save error:', error);
            }
        }

        function loadChatsFromLocalStorage() {
            try {
                if (!state.currentUser) return false;
                const saved = localStorage.getItem(`helaChats_${state.currentUser.uid}`);
                if (saved) {
                    state.chats = JSON.parse(saved);
                    console.log(`Loaded ${state.chats.length} chats from local storage`);
                    return true;
                }
                return false;
            } catch (error) {
                console.error('Local storage load error:', error);
                return false;
            }
        }

        // ==================== CHAT MANAGEMENT ====================
        async function createNewChat(specificId = null) {
            try {
                const newChat = {
                    id: specificId || generateChatId(),
                    title: 'New Chat',
                    messages: [],
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                
                state.chats.unshift(newChat);
                state.currentChatId = newChat.id;
                
                // Track chat creation
                updateUserStats({ chatsCreated: 1 });
                
                await saveChatToFirestore(newChat);
                saveChatsToLocalStorage();
                
                // Update UI
                if (elements.chatMessages) {
                    elements.chatMessages.innerHTML = '';
                }
                if (elements.welcomeScreen) {
                    elements.welcomeScreen.style.display = 'flex';
                }
                
                updateURL(state.currentChatId);
                updateChatHistorySidebar();
                
                console.log('Created new chat:', newChat.id);
                return newChat.id;
            } catch (error) {
                console.error('Error creating new chat:', error);
                showNotification('Error creating chat', 'error');
                return null;
            }
        }

        async function loadChat(chatId) {
            try {
                console.log('Loading chat:', chatId);
                
                const chat = state.chats.find(c => c.id === chatId);
                if (!chat) {
                    console.error('Chat not found:', chatId);
                    showNotification('Chat not found', 'error');
                    return false;
                }
                
                state.currentChatId = chatId;
                
                // Clear chat area
                if (elements.chatMessages) {
                    elements.chatMessages.innerHTML = '';
                }
                
                // Show/hide welcome screen based on messages
                if (elements.welcomeScreen) {
                    if (chat.messages && chat.messages.length > 0) {
                        elements.welcomeScreen.style.display = 'none';
                    } else {
                        elements.welcomeScreen.style.display = 'flex';
                    }
                }
                
                // Rebuild messages
                if (chat.messages && chat.messages.length > 0) {
                    console.log(`Rebuilding ${chat.messages.length} messages`);
                    chat.messages.forEach(msg => {
                        if (msg.type === 'user') {
                            addMessageToUI('user', msg.content);
                        } else {
                            displayAIResponse(msg.content);
                        }
                    });
                }
                
                updateURL(state.currentChatId);
                updateChatHistorySidebar();
                scrollToBottom();
                
                console.log('Chat loaded successfully:', chatId);
                return true;
            } catch (error) {
                console.error('Error loading chat:', error);
                showNotification('Error loading chat', 'error');
                return false;
            }
        }

        async function deleteChat(chatId, event) {
            try {
                if (event) event.stopPropagation();
                
                if (!confirm('Are you sure you want to delete this chat?')) {
                    return;
                }
                
                state.chats = state.chats.filter(chat => chat.id !== chatId);
                
                await deleteChatFromFirestore(chatId);
                saveChatsToLocalStorage();
                
                if (state.currentChatId === chatId) {
                    if (state.chats.length > 0) {
                        state.currentChatId = state.chats[0].id;
                        await loadChat(state.currentChatId);
                    } else {
                        await createNewChat();
                    }
                }
                
                updateChatHistorySidebar();
                showNotification('Chat deleted');
            } catch (error) {
                console.error('Error deleting chat:', error);
                showNotification('Error deleting chat', 'error');
            }
        }

        function updateChatTitle(chatId, firstMessage) {
            try {
                const chat = state.chats.find(c => c.id === chatId);
                if (chat && chat.title === 'New Chat') {
                    const title = firstMessage.length > 30 
                        ? firstMessage.substring(0, 30) + '...' 
                        : firstMessage;
                    chat.title = title;
                    chat.updatedAt = new Date().toISOString();
                    
                    saveChatToFirestore(chat);
                    saveChatsToLocalStorage();
                    
                    updateChatHistorySidebar();
                }
            } catch (error) {
                console.error('Error updating chat title:', error);
            }
        }

        async function addMessageToChat(sender, content) {
            try {
                if (!state.currentChatId) return;
                
                const chat = state.chats.find(c => c.id === state.currentChatId);
                if (!chat) return;
                
                chat.messages.push({
                    type: sender,
                    content: content,
                    timestamp: new Date().toISOString()
                });
                
                if (chat.messages.length > 100) {
                    chat.messages = chat.messages.slice(-100);
                }
                
                chat.updatedAt = new Date().toISOString();
                
                if (sender === 'user' && chat.messages.length === 1) {
                    await updateChatTitle(state.currentChatId, content);
                }
                
                await saveChatToFirestore(chat);
                saveChatsToLocalStorage();
                
                updateChatHistorySidebar();
            } catch (error) {
                console.error('Error adding message to chat:', error);
                showNotification('Error saving message', 'error');
            }
        }

        function updateChatHistorySidebar() {
            try {
                if (!elements.chatHistory) return;
                
                elements.chatHistory.innerHTML = '';
                
                if (state.chats.length === 0) {
                    elements.chatHistory.innerHTML = '<div class="no-chats">No conversations yet</div>';
                    return;
                }
                
                state.chats.forEach(chat => {
                    const chatItem = document.createElement('div');
                    chatItem.className = `chat-item ${chat.id === state.currentChatId ? 'active' : ''}`;
                    chatItem.innerHTML = `
                        <span class="chat-item-icon">ðŸ’¬</span>
                        <span class="chat-item-title">${escapeHTML(chat.title)}</span>
                        <div class="chat-actions">
                            <button class="share-chat" onclick="shareChat('${chat.id}')" title="Share chat">
                                <i class="fas fa-share"></i>
                            </button>
                            <button class="delete-chat" onclick="deleteChat('${chat.id}', event)" title="Delete chat">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                    
                    chatItem.addEventListener('click', function(e) {
                        if (!e.target.closest('.chat-actions')) {
                            loadChat(chat.id);
                        }
                    });
                    
                    elements.chatHistory.appendChild(chatItem);
                });
            } catch (error) {
                console.error('Error updating chat history:', error);
            }
        }

        // ==================== UI MESSAGE FUNCTIONS ====================
        function addMessageToUI(sender, text) {
            try {
                if (!elements.chatMessages) return;
                
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${sender}`;
                
                const messageContent = document.createElement('div');
                messageContent.className = 'message-content';
                
                if (sender === 'ai') {
                    const avatar = document.createElement('div');
                    avatar.className = 'message-avatar';
                    avatar.textContent = 'H';
                    messageDiv.appendChild(avatar);
                }
                
                const messageBubble = document.createElement('div');
                messageBubble.className = `message-bubble ${sender === 'ai' ? 'ai-bubble' : ''}`;
                messageBubble.textContent = text;
                
                messageContent.appendChild(messageBubble);
                messageDiv.appendChild(messageContent);
                
                if (sender === 'user') {
                    const avatar = document.createElement('div');
                    avatar.className = 'message-avatar';
                    avatar.textContent = 'U';
                    avatar.style.background = '#666';
                    messageDiv.appendChild(avatar);
                }
                
                elements.chatMessages.appendChild(messageDiv);
                
                scrollToBottom();
            } catch (error) {
                console.error('Error adding message to UI:', error);
            }
        }

        // ==================== CODE SYNTAX HIGHLIGHTING ====================
        function copyToClipboard(button) {
            try {
                const codeBlock = button.closest('.code-block');
                const codeElement = codeBlock.querySelector('code');
                const codeText = codeElement.textContent;
                
                navigator.clipboard.writeText(codeText).then(() => {
                    const originalText = button.textContent;
                    button.textContent = 'Copied!';
                    button.style.background = 'var(--success)';
                    
                    setTimeout(() => {
                        button.textContent = originalText;
                        button.style.background = '';
                    }, 2000);
                }).catch(err => {
                    console.error('Failed to copy code:', err);
                    button.textContent = 'Failed';
                    button.style.background = 'var(--error)';
                });
            } catch (error) {
                console.error('Error copying code:', error);
            }
        }

        function addCopyCodeListeners() {
            document.querySelectorAll('.copy-code-btn').forEach(btn => {
                btn.onclick = function() {
                    copyToClipboard(this);
                };
            });
            
            document.querySelectorAll('.download-code-btn').forEach(btn => {
                btn.onclick = function() {
                    downloadCode(this);
                };
            });
        }

        // ==================== CORRECTED AI RESPONSE DISPLAY FUNCTION ====================
        function displayAIResponse(content) {
            try {
                if (!elements.chatMessages) return;
                
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message ai';
                
                const avatar = document.createElement('div');
                avatar.className = 'message-avatar';
                avatar.textContent = 'H';
                messageDiv.appendChild(avatar);
                
                const messageContent = document.createElement('div');
                messageContent.className = 'message-content';
                
                const messageBubble = document.createElement('div');
                messageBubble.className = 'message-bubble ai-bubble';
                
                // Check if the content contains actual code blocks with triple backticks
                const hasCodeBlocks = content.includes('```');
                
                let formattedContent = content;
                
                if (hasCodeBlocks) {
                    // Only apply code block formatting if actual code blocks exist
                    formattedContent = content
                        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                        .replace(/\*(.*?)\*/g, '<em>$1</em>')
                        .replace(/`([^`]+)`/g, '<code>$1</code>')
                        .replace(/```(\w+)?\n([\s\S]*?)```/g, function(match, lang, code) {
                            const language = lang || 'text';
                            return `
        <div class="code-block">
            <div class="code-header">
                <span>${language}</span>
                <div>
                    <button class="copy-code-btn">Copy</button>
                    <button class="download-code-btn">Download</button>
                </div>
            </div>
            <pre><code class="language-${language}">${escapeHTML(code.trim())}</code></pre>
        </div>
        `;
                        });
                } else {
                    // For regular text responses, only apply basic formatting
                    formattedContent = content
                        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                        .replace(/\*(.*?)\*/g, '<em>$1</em>')
                        .replace(/`([^`]+)`/g, '<code>$1</code>')
                        // Convert line breaks to <br> tags for regular text
                        .replace(/\n/g, '<br>');
                }
                
                messageBubble.innerHTML = formattedContent;
                
                messageContent.appendChild(messageBubble);
                messageDiv.appendChild(messageContent);
                elements.chatMessages.appendChild(messageDiv);
                
                // Only add copy functionality if there are actual code blocks
                if (hasCodeBlocks) {
                    addCopyCodeListeners();
                }
                
                scrollToBottom();
            } catch (error) {
                console.error('Error displaying AI response:', error);
            }
        }

        function downloadCode(button) {
            try {
                const codeBlock = button.closest('.code-block');
                const codeElement = codeBlock.querySelector('code');
                const language = codeBlock.querySelector('.code-header span').textContent;
                const codeText = codeElement.textContent;
                
                const blob = new Blob([codeText], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `code.${getFileExtension(language)}`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showNotification('Code downloaded successfully!', 'success');
            } catch (error) {
                console.error('Error downloading code:', error);
                showNotification('Error downloading code', 'error');
            }
        }

        function getFileExtension(language) {
            const extensions = {
                'javascript': 'js',
                'python': 'py',
                'html': 'html',
                'css': 'css',
                'java': 'java',
                'php': 'php',
                'sql': 'sql',
                'json': 'json',
                'bash': 'sh',
                'text': 'txt'
            };
            return extensions[language.toLowerCase()] || 'txt';
        }

        // ==================== AI API ====================
        async function callAI(userMessage, conversationContext = []) {
            try {
                // Build context-aware message
                let contextAwareMessage = userMessage;
                if (conversationContext.length > 0) {
                    contextAwareMessage = "Previous conversation context:\n";
                    conversationContext.forEach(msg => {
                        const role = msg.type === 'user' ? 'User' : 'Assistant';
                        contextAwareMessage += `${role}: ${msg.content}\n`;
                    });
                    contextAwareMessage += `\nCurrent user message: ${userMessage}`;
                }

                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 second timeout

                const response = await fetch(API_CONFIG.URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_CONFIG.KEY}`
                    },
                    body: JSON.stringify({ 
                        message: contextAwareMessage,
                        model: API_CONFIG.MODEL,
                        system_prompt: SYSTEM_PROMPT,
                        temperature: 0.7,
                        max_tokens: 2000
                    }),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    throw new Error(`API error: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (!data.response) {
                    throw new Error('Invalid API response format');
                }
                
                return data.response;
                
            } catch (error) {
                console.error('AI API Error:', error);
                if (error.name === 'AbortError') {
                    throw new Error('Request timeout - please try again');
                }
                throw error;
            }
        }

        // ==================== USER ACTIVITY TRACKING ====================
        function analyzeMessageForStats(message) {
            const stats = {
                messagesSent: 1,
                codeQuestions: 0,
                filesUploaded: 0
            };

            // Check if this is a coding-related question
            const codeKeywords = [
                'code', 'function', 'variable', 'bug', 'error', 'syntax', 'algorithm',
                'programming', 'develop', 'script', 'api', 'database', 'server',
                'react', 'javascript', 'python', 'java', 'html', 'css', 'node',
                'debug', 'fix', 'implement', 'create a', 'how to', 'build a'
            ];
            
            const lowerMessage = message.toLowerCase();
            if (codeKeywords.some(keyword => lowerMessage.includes(keyword))) {
                stats.codeQuestions = 1;
            }

            return stats;
        }

        async function trackUserActivity(message) {
            try {
                if (!state.currentUser) return;

                // Analyze message for stats
                const messageStats = analyzeMessageForStats(message);
                updateUserStats(messageStats);

            } catch (error) {
                console.error('Error tracking user activity:', error);
            }
        }

        // ==================== MAIN CHAT HANDLER ====================
        async function handleSend() {
            try {
                const text = elements.chatInput?.value.trim() || '';
                
                if (!text) {
                    showNotification('Please enter a message', 'error');
                    return;
                }
                
                // Disable send button during processing
                if (elements.sendBtn) {
                    elements.sendBtn.disabled = true;
                    elements.sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                }
                
                if (elements.chatInput) {
                    elements.chatInput.value = '';
                    autoResizeTextarea();
                }
                
                if (!state.currentChatId || state.chats.length === 0) {
                    await createNewChat();
                }
                
                if (elements.welcomeScreen) {
                    elements.welcomeScreen.style.display = 'none';
                }

                addMessageToUI('user', text);
                await addMessageToChat('user', text);

                // Track achievements and challenges
                await trackUserActivity(text);

                showTypingIndicator();
                
                try {
                    // Get conversation context for better responses
                    const currentChat = state.chats.find(chat => chat.id === state.currentChatId);
                    const conversationContext = currentChat?.messages?.slice(-6) || [];
                    
                    const reply = await callAI(text, conversationContext);
                    removeTypingIndicator();
                    displayAIResponse(reply);
                    await addMessageToChat('ai', reply);
                } catch (error) {
                    removeTypingIndicator();
                    console.error('AI API Error:', error);
                    const errorMessage = "Sorry, I'm having trouble connecting right now. Please try again in a moment.";
                    displayAIResponse(errorMessage);
                    await addMessageToChat('ai', errorMessage);
                }
            } catch (error) {
                console.error('Error in handleSend:', error);
                showNotification('Error sending message', 'error');
            } finally {
                // Re-enable send button
                if (elements.sendBtn) {
                    elements.sendBtn.disabled = false;
                    elements.sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i>';
                }
            }
        }

        // ==================== USER PROGRESS MANAGEMENT ====================
        async function loadUserProgress(userId) {
            try {
                const userDoc = await db.collection('users').doc(userId).get();
                
                if (userDoc.exists && userDoc.data().progress) {
                    state.userProgress = { ...state.userProgress, ...userDoc.data().progress };
                }
                
                // Initialize daily challenge tracking
                await initializeDailyChallenges();
                
                updateProgressUI();
                
            } catch (error) {
                console.error('Error loading user progress:', error);
            }
        }

        async function initializeDailyChallenges() {
            try {
                const today = new Date().toDateString();
                const lastActive = state.userProgress.lastActive;
                
                if (lastActive === today) {
                    // Already active today
                    return;
                } else if (lastActive && isConsecutiveDay(lastActive, today)) {
                    // Consecutive day
                    state.userProgress.stats.consecutiveDays += 1;
                } else {
                    // New streak or broken streak
                    state.userProgress.stats.consecutiveDays = 1;
                }
                
                state.userProgress.lastActive = today;
                await saveUserProgress();
                
            } catch (error) {
                console.error('Error initializing daily challenges:', error);
            }
        }

        function isConsecutiveDay(lastDate, currentDate) {
            const last = new Date(lastDate);
            const current = new Date(currentDate);
            const diffTime = Math.abs(current - last);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return diffDays === 1;
        }

        // ==================== USER AUTH & INIT ====================
        function updateUserInfo(user) {
            try {
                if (elements.userName) {
                    elements.userName.textContent = user.displayName || user.email || 'User';
                }
                
                if (elements.userAvatar) {
                    const initial = (user.displayName || user.email || 'U').charAt(0).toUpperCase();
                    
                    if (user.photoURL) {
                        elements.userAvatar.innerHTML = '';
                        elements.userAvatar.style.backgroundImage = `url(${user.photoURL})`;
                        elements.userAvatar.style.backgroundSize = 'cover';
                        elements.userAvatar.style.backgroundPosition = 'center';
                    } else {
                        elements.userAvatar.innerHTML = initial;
                        elements.userAvatar.style.backgroundImage = 'none';
                    }
                }
                
                // Update level display
                const userLevel = document.getElementById('userLevel');
                if (userLevel) {
                    userLevel.textContent = state.userProgress.level;
                }
                
            } catch (error) {
                console.error('Error updating user info:', error);
            }
        }

        // ==================== URL ROUTING ====================
        function getChatIdFromURL() {
            try {
                const hash = window.location.hash;
                if (hash && hash.startsWith('#')) {
                    const chatId = hash.substring(1);
                    // Validate chat ID format
                    if (chatId && chatId.startsWith('chat_')) {
                        return chatId;
                    }
                }
                return null;
            } catch (error) {
                console.error('Error getting chat ID from URL:', error);
                return null;
            }
        }

        function updateURL(chatId) {
            try {
                if (!chatId || !chatId.startsWith('chat_')) {
                    console.warn('Invalid chat ID for URL update:', chatId);
                    return;
                }
                
                // Use replaceState to avoid adding to browser history
                window.history.replaceState(null, null, `#${chatId}`);
                
                console.log('URL updated with chat ID:', chatId);
            } catch (error) {
                console.error('Error updating URL:', error);
            }
        }

        async function initializeApp() {
            return new Promise((resolve, reject) => {
                auth.onAuthStateChanged(async (user) => {
                    try {
                        if (user) {
                            state.currentUser = user;
                            updateUserInfo(user);
                            
                            // Load user progress and chats
                            await Promise.all([
                                loadUserProgress(user.uid),
                                loadChatsFromFirestore().then(success => {
                                    if (!success) loadChatsFromLocalStorage();
                                })
                            ]);
                            
                            // Handle URL routing
                            const urlChatId = getChatIdFromURL();
                            let chatToLoad = null;
                            
                            if (urlChatId) {
                                const urlChat = state.chats.find(chat => chat.id === urlChatId);
                                chatToLoad = urlChat ? urlChatId : (await createNewChat(urlChatId));
                            } else if (state.chats.length > 0) {
                                chatToLoad = state.chats[0].id;
                            } else {
                                chatToLoad = await createNewChat();
                            }
                            
                            if (chatToLoad) {
                                await loadChat(chatToLoad);
                            }
                            
                            state.isInitialized = true;
                            console.log('App initialized successfully');
                            resolve(user);
                            
                        } else {
                            window.location.href = 'index.html';
                        }
                    } catch (error) {
                        console.error('Error in auth state change:', error);
                        reject(error);
                    }
                }, reject);
            });
        }

        // ==================== EVENT LISTENERS ====================
        function setupEventListeners() {
            try {
                console.log('Setting up event listeners...');
                
                // Chat functionality
                if (elements.sendBtn) {
                    elements.sendBtn.addEventListener('click', handleSend);
                }

                if (elements.chatInput) {
                    elements.chatInput.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter' && !e.shiftKey) {
                            e.preventDefault();
                            handleSend();
                        }
                    });
                    
                    elements.chatInput.addEventListener('input', autoResizeTextarea);
                }

                if (elements.newChatBtn) {
                    elements.newChatBtn.addEventListener('click', createNewChat);
                }

                // Auth
                if (elements.logoutBtn) {
                    elements.logoutBtn.addEventListener('click', () => {
                        auth.signOut().then(() => {
                            window.location.href = 'index.html';
                        });
                    });
                }

                // Achievements & Challenges
                if (elements.challengesBtn) {
                    elements.challengesBtn.addEventListener('click', showChallengesModal);
                }

                if (elements.achievementsBtn) {
                    elements.achievementsBtn.addEventListener('click', showAchievementsModal);
                }

                // URL routing
                window.addEventListener('hashchange', () => {
                    try {
                        const chatId = getChatIdFromURL();
                        if (chatId && state.chats.some(chat => chat.id === chatId)) {
                            console.log('Loading chat from URL:', chatId);
                            loadChat(chatId);
                        } else if (chatId) {
                            console.log('Chat not found, creating new one:', chatId);
                            createNewChat(chatId).then(newChatId => {
                                if (newChatId) {
                                    loadChat(newChatId);
                                }
                            });
                        }
                    } catch (error) {
                        console.error('Error handling hash change:', error);
                        showNotification('Error loading chat from URL', 'error');
                    }
                });

                console.log('Event listeners setup complete');
            } catch (error) {
                console.error('Error setting up event listeners:', error);
            }
        }

        // ==================== START APPLICATION ====================
        async function startApplication() {
            try {
                console.log('Starting Hela Code application...');
                
                // Wait for DOM elements
                const elementsReady = await initializeElements();
                if (!elementsReady) {
                    throw new Error('Failed to initialize DOM elements');
                }
                
                // Setup event listeners
                setupEventListeners();
                
                // Display example prompts
                displayExamplePrompts();
                
                // Initialize app with authentication
                await initializeApp();
                
                // Show success message
                showNotification('Hela Code loaded successfully!');
                
                console.log('Hela Code application started successfully');
                
            } catch (error) {
                console.error('Failed to start application:', error);
                showNotification('Failed to load app. Please refresh the page.', 'error');
                
                // Try to recover after 3 seconds
                setTimeout(() => {
                    window.location.reload();
                }, 3000);
            }
        }

        // ==================== GLOBAL FUNCTIONS ====================
        window.handleSend = handleSend;
        window.handleExamplePrompt = handleExamplePrompt;
        window.deleteChat = deleteChat;
        window.shareChat = shareChat;
        window.showChallengesModal = showChallengesModal;
        window.showAchievementsModal = showAchievementsModal;
        window.copyToClipboard = copyToClipboard;
        window.downloadCode = downloadCode;
        window.reloadApp = () => {
            showNotification('Reloading app...');
            window.location.reload();
        };

        // Start the application when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', startApplication);
        } else {
            startApplication();
        }
    </script>
</body>
</html>
